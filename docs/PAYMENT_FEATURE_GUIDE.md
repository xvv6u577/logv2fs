# 费用管理功能使用指南

## 功能概述

费用管理功能允许管理员记录和统计用户的VPN服务续费信息。主要特点：

- **精确到天的服务期限管理**：记录每次续费对应的服务开始和结束日期
- **完整的续费历史记录**：追踪每个用户的所有续费记录
- **多维度统计分析**：支持按日、月、年查看收入统计
- **用户级别查看**：在用户管理界面直接查看用户的续费记录

## 使用步骤

### 1. 初始化数据库

首次使用前需要运行迁移命令创建相关数据表：

```bash
# PostgreSQL 用户
./logv2fs migrate payment

# MongoDB 用户（会自动创建集合和索引）
./logv2fs migrate payment
```

### 2. 添加续费记录

1. 使用管理员账号登录系统
2. 在菜单中选择 "Add Payment"
3. 填写续费信息：
   - **选择用户**：从下拉列表中选择要续费的用户
   - **续费金额**：输入本次续费的金额（元）
   - **服务开始日期**：选择VPN服务的开始日期
   - **服务结束日期**：选择VPN服务的结束日期（系统会自动计算服务天数）
   - **备注**：可选，记录特殊说明或优惠信息

### 3. 查看费用统计

1. 在菜单中选择 "Payment Stats"
2. 选择统计类型：
   - **日统计**：查看每日的收入情况
   - **月统计**：查看每月的收入情况
   - **年统计**：查看每年的收入情况
   - **汇总**：查看最近的统计概览
3. 设置日期范围以筛选特定时期的数据

### 4. 查看用户续费记录

在用户管理界面，点击任意用户的"详情"按钮，即可在弹出的模态框中查看该用户的：
- 续费汇总信息（总金额、续费次数、最近续费日期）
- 详细续费记录列表（服务期间、金额、备注等）

## 数据说明

### 续费记录字段

- **user_email_as_id**：用户邮箱（唯一标识）
- **user_name**：用户名
- **amount**：续费金额
- **start_date**：服务开始日期
- **end_date**：服务结束日期
- **remark**：备注信息
- **operator_email**：操作员邮箱（自动记录）
- **operator_name**：操作员名称（自动记录）
- **created_at**：记录创建时间
- **updated_at**：记录更新时间

### 统计数据

统计数据包含以下信息：
- **总收入**：选定时期内的总续费金额
- **续费次数**：选定时期内的续费总次数
- **续费用户数**：选定时期内有续费记录的用户数量
- **平均金额**：总收入除以续费次数

## API 接口

### 添加续费记录
```
POST /v1/payment
{
  "user_email_as_id": "user@example.com",
  "amount": 100,
  "start_date": "2024-01-01",
  "end_date": "2024-01-31",
  "remark": "月度续费"
}
```

### 获取用户续费记录
```
GET /v1/payment/user/:email
```

### 获取费用统计
```
GET /v1/payment/statistics?type=daily&start_date=2024-01-01&end_date=2024-12-31
```

参数说明：
- `type`: 统计类型（daily/monthly/yearly/summary）
- `start_date`: 开始日期（格式：YYYY-MM-DD）
- `end_date`: 结束日期（格式：YYYY-MM-DD）

### 删除续费记录
```
DELETE /v1/payment/:id
```

### 更新续费记录
```
PUT /v1/payment/:id
{
  "amount": 150,
  "start_date": "2024-01-01",
  "end_date": "2024-02-01",
  "remark": "更新备注"
}
```

## 安全说明

- 所有费用管理相关操作都需要管理员权限
- 系统会自动记录操作员信息，确保操作可追溯
- 删除操作需要谨慎，建议在删除前备份重要数据

## 注意事项

1. **服务期限计算**：系统会根据开始和结束日期自动计算服务天数，方便核对
2. **日期验证**：系统会验证结束日期必须晚于开始日期
3. **统计时间**：统计数据基于服务开始日期进行分组
4. **权限控制**：只有管理员可以添加、修改、删除续费记录和查看统计数据 